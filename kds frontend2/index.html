<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Kodland Community</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
			rel="stylesheet"
		/>
		<style>
			.navbar {
				background-color: #343a40;
			}
			.navbar-brand {
				color: white;
			}
			.nav-link {
				color: rgba(255, 255, 255, 0.75);
			}
			.nav-link:hover {
				color: rgba(255, 255, 255, 1);
			}
			.avatar-img {
				width: 40px;
				height: 40px;
				object-fit: cover;
				border-radius: 50%;
			}
			.member-card {
				cursor: pointer;
				transition: transform 0.2s;
			}
			.member-card:hover {
				transform: translateY(-5px);
			}
			.stat-item {
				display: inline-flex;
				align-items: center;
				margin-right: 10px;
			}
			.stat-icon {
				margin-right: 5px;
				color: #6c757d;
			}
			.like-btn {
				background: none;
				border: none;
				padding: 0;
				cursor: pointer;
				color: #6c757d;
			}
			.like-btn:hover {
				color: #dc3545;
			}
			.like-btn.liked {
				color: #dc3545;
			}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-dark">
			<div class="container">
				<a class="navbar-brand" href="/">Kodland Community</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarNav"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a class="nav-link" href="/admin.html">Админ-панель</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container mt-4">
			<div class="row mb-4">
				<div class="col-md-6">
					<div class="input-group">
						<input
							type="text"
							class="form-control"
							id="searchInput"
							placeholder="Поиск по имени..."
						/>
						<button
							class="btn btn-outline-secondary"
							type="button"
							onclick="search()"
						>
							<i class="bi bi-search"></i>
						</button>
					</div>
				</div>
				<div class="col-md-6">
					<div class="input-group">
						<select class="form-select" id="sortSelect" onchange="sort()">
							<option value="recent">Сначала новые</option>
							<option value="name">По имени</option>
							<option value="likes">По лайкам</option>
						</select>
					</div>
				</div>
			</div>

			<div class="row" id="membersGrid"></div>
		</div>

		<div
			class="modal fade"
			id="userModal"
			tabindex="-1"
			aria-labelledby="userModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="userModalLabel">
							Информация о пользователе
						</h5>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"
						></button>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-md-4 text-center">
								<img
									id="modalAvatar"
									src=""
									alt="Avatar"
									class="img-fluid rounded-circle mb-3"
									style="width: 150px; height: 150px; object-fit: cover"
								/>
								<h4 id="modalName"></h4>
								<div class="mb-3">
									<button
										class="like-btn"
										id="modalLikeBtn"
										onclick="toggleLike()"
									>
										<i class="bi bi-heart"></i>
										<span id="modalLikes">0</span>
									</button>
								</div>
							</div>
							<div class="col-md-8">
								<h5>Достижения</h5>
								<ul id="modalAchievements"></ul>
								<h5>Роли</h5>
								<ul id="modalRoles"></ul>
								<h5>Ссылки</h5>
								<ul id="modalLinks"></ul>
								<h5>Медали</h5>
								<div>
									<span class="badge bg-warning" id="modalGoldMedals">0</span>
									<span class="badge bg-secondary" id="modalSilverMedals"
										>0</span
									>
									<span class="badge bg-danger" id="modalBronzeMedals">0</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			const API_URL = 'http://localhost:8080/api'
			let currentUser = null

			document.addEventListener('DOMContentLoaded', () => {
				loadMembers()
			})

			async function loadMembers() {
				try {
					const response = await fetch(`${API_URL}/users`)
					if (!response.ok) {
						throw new Error('Ошибка загрузки данных')
					}
					const data = await response.json()
					displayMembers(data.users)
				} catch (error) {
					console.error('Ошибка:', error)
				}
			}

			function displayMembers(users) {
				const grid = document.getElementById('membersGrid')
				grid.innerHTML = ''

				users.forEach(user => {
					const col = document.createElement('div')
					col.className = 'col-md-4 mb-4'
					col.innerHTML = `
						<div class="card member-card" onclick="showUserModal(${user.id})">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<img src="${user.avatar_url}" alt="Avatar" class="avatar-img me-3">
									<div>
										<h5 class="card-title mb-1">${user.nickname}</h5>
										<div class="stat-item">
											<i class="bi bi-heart-fill stat-icon"></i>
											<span>${user.likes}</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					`
					grid.appendChild(col)
				})
			}

			async function showUserModal(id) {
				try {
					const response = await fetch(`${API_URL}/users/${id}`)
					if (!response.ok) {
						throw new Error('Пользователь не найден')
					}
					const user = await response.json()
					currentUser = user

					document.getElementById('modalAvatar').src = user.avatar_url
					document.getElementById('modalName').textContent = user.nickname
					document.getElementById('modalLikes').textContent = user.likes

					const achievementsList = document.getElementById('modalAchievements')
					achievementsList.innerHTML = ''
					user.achievements.forEach(achievement => {
						const li = document.createElement('li')
						li.textContent = achievement
						achievementsList.appendChild(li)
					})

					const rolesList = document.getElementById('modalRoles')
					rolesList.innerHTML = ''
					user.roles.forEach(role => {
						const li = document.createElement('li')
						li.textContent = role
						rolesList.appendChild(li)
					})

					const linksList = document.getElementById('modalLinks')
					linksList.innerHTML = ''
					user.links.forEach(link => {
						const li = document.createElement('li')
						const a = document.createElement('a')
						a.href = link
						a.textContent = link
						a.target = '_blank'
						li.appendChild(a)
						linksList.appendChild(li)
					})

					document.getElementById('modalGoldMedals').textContent =
						user.medals.gold
					document.getElementById('modalSilverMedals').textContent =
						user.medals.silver
					document.getElementById('modalBronzeMedals').textContent =
						user.medals.bronze

					new bootstrap.Modal(document.getElementById('userModal')).show()
				} catch (error) {
					console.error('Ошибка при загрузке данных пользователя:', error)
					alert('Не удалось загрузить данные пользователя')
				}
			}

			async function toggleLike() {
				if (!currentUser) return

				const likeBtn = document.getElementById('modalLikeBtn')
				const likesSpan = document.getElementById('modalLikes')
				const isLiked = likeBtn.classList.contains('liked')

				try {
					const response = await fetch(
						`${API_URL}/users/${currentUser.id}/like`,
						{
							method: isLiked ? 'DELETE' : 'POST',
						}
					)

					if (response.ok) {
						const data = await response.json()
						likesSpan.textContent = data.likes
						likeBtn.classList.toggle('liked')
						updateCardLikes(currentUser.id, data.likes)
					} else {
						throw new Error('Ошибка при обновлении лайков')
					}
				} catch (error) {
					console.error('Ошибка:', error)
					alert('Не удалось обновить лайки')
				}
			}

			function updateCardLikes(userId, likes) {
				const cards = document.querySelectorAll('.member-card')
				cards.forEach(card => {
					if (card.getAttribute('onclick').includes(userId)) {
						const likesSpan = card.querySelector('.stat-item span')
						if (likesSpan) {
							likesSpan.textContent = likes
						}
					}
				})
			}

			function search() {
				const searchTerm = document
					.getElementById('searchInput')
					.value.toLowerCase()
				const cards = document.querySelectorAll('.member-card')

				cards.forEach(card => {
					const name = card
						.querySelector('.card-title')
						.textContent.toLowerCase()
					card.parentElement.style.display = name.includes(searchTerm)
						? 'block'
						: 'none'
				})
			}

			function sort() {
				const sortBy = document.getElementById('sortSelect').value
				const grid = document.getElementById('membersGrid')
				const cards = Array.from(grid.querySelectorAll('.member-card'))

				cards.sort((a, b) => {
					const aName = a.querySelector('.card-title').textContent
					const aLikes = parseInt(
						a.querySelector('.stat-item span').textContent
					)
					const bName = b.querySelector('.card-title').textContent
					const bLikes = parseInt(
						b.querySelector('.stat-item span').textContent
					)

					switch (sortBy) {
						case 'name':
							return aName.localeCompare(bName)
						case 'likes':
							return bLikes - aLikes
						default:
							return 0
					}
				})

				cards.forEach(card => {
					grid.appendChild(card.parentElement)
				})
			}
		</script>
	</body>
</html>
